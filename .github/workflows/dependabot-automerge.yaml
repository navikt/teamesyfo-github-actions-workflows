name: Dependabot auto-approve and auto-merge

# Reusable workflow that auto-approves and enables auto-merge for safe
# Dependabot PRs (patch and minor updates). Major updates are left for
# manual review.
#
# Prerequisites (recommended):
#   - Branch protection with required status checks (e.g. a CI merge gate)
#     on the default branch. Without required checks, PRs may merge immediately.
#   - "Allow auto-merge" must be enabled in the repo settings.
#
# Secrets:
#   APP_PRIVATE_KEY – GitHub App private key (.pem contents) for the
#     teamesyfo-automerge App (ID 2906300). The App must be installed on
#     the calling repo with permissions: contents:write + pull-requests:write.
#
#   A short-lived installation token is generated at runtime; this avoids
#   the GITHUB_TOKEN limitation that blocks merge_group event triggering.

on:
  workflow_call:
    secrets:
      APP_PRIVATE_KEY:
        description: "GitHub App private key (.pem) for teamesyfo-automerge. Required to generate short-lived tokens that can trigger merge_group events."
        required: true

jobs:
  dependabot:
    runs-on: ubuntu-latest
    if: >-
      ${{
        github.event.pull_request.user.login == 'dependabot[bot]' &&
        !github.event.pull_request.head.repo.fork
      }}
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: 2906300 # teamesyfo-automerge
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Fetch Dependabot metadata
        id: dependabot-metadata
        uses: dependabot/fetch-metadata@21025c705c08248db411dc16f3619e6b5f9ea21a # v2.5.0

      - name: Decide auto-merge policy
        id: policy
        shell: bash
        run: |
          set -euo pipefail

          update_type='${{ steps.dependabot-metadata.outputs.update-type }}'
          echo "Update type: $update_type"

          if [[ "$update_type" == "version-update:semver-patch" || "$update_type" == "version-update:semver-minor" ]]; then
            echo "should_automerge=true" >> "$GITHUB_OUTPUT"
          else
            echo "Major or unknown update — skipping auto-merge."
            echo "should_automerge=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Approve PR if safe
        if: ${{ steps.policy.outputs.should_automerge == 'true' }}
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          decision="$(gh pr view "$PR_URL" --json reviewDecision -q .reviewDecision)"
          if [[ "$decision" != "APPROVED" ]]; then
            gh pr review --approve "$PR_URL" -b "Auto-approving safe Dependabot update (patch/minor)."
          else
            echo "PR already approved."
          fi

      - name: Enable auto-merge if safe
        if: ${{ steps.policy.outputs.should_automerge == 'true' }}
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          # Use GitHub App token to enable auto-merge.
          # GITHUB_TOKEN cannot trigger merge_group events.
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          set -euo pipefail
          gh pr merge --auto --squash "$PR_URL"
