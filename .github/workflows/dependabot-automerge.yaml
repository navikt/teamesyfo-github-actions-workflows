name: Dependabot auto-approve and auto-merge

# Reusable workflow that auto-approves and enables auto-merge for safe
# Dependabot PRs (patch and minor updates). Major updates are left for
# manual review.
#
# Prerequisites (recommended):
#   - Branch protection with required status checks (e.g. a CI merge gate)
#     on the default branch. Without required checks, PRs may merge immediately.
#   - "Allow auto-merge" must be enabled in the repo settings.

on:
  workflow_call:

jobs:
  dependabot:
    runs-on: ubuntu-latest
    if: >-
      ${{
        github.event.pull_request.user.login == 'dependabot[bot]' &&
        !github.event.pull_request.head.repo.fork
      }}
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Fetch Dependabot metadata
        id: dependabot-metadata
        uses: dependabot/fetch-metadata@21025c705c08248db411dc16f3619e6b5f9ea21a # v2.5.0

      - name: Decide auto-merge policy
        id: policy
        shell: bash
        run: |
          set -euo pipefail

          update_type='${{ steps.dependabot-metadata.outputs.update-type }}'
          echo "Update type: $update_type"

          if [[ "$update_type" == "version-update:semver-patch" || "$update_type" == "version-update:semver-minor" ]]; then
            echo "should_automerge=true" >> "$GITHUB_OUTPUT"
          else
            echo "Major or unknown update â€” skipping auto-merge."
            echo "should_automerge=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Approve PR if safe
        if: ${{ steps.policy.outputs.should_automerge == 'true' }}
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          decision="$(gh pr view "$PR_URL" --json reviewDecision -q .reviewDecision)"
          if [[ "$decision" != "APPROVED" ]]; then
            gh pr review --approve "$PR_URL" -b "Auto-approving safe Dependabot update (patch/minor)."
          else
            echo "PR already approved."
          fi

      - name: Enable auto-merge if safe
        if: ${{ steps.policy.outputs.should_automerge == 'true' }}
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_SHA: ${{ github.event.pull_request.head.sha }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          gh pr merge --auto --squash --match-head-commit "$PR_SHA" "$PR_URL"
