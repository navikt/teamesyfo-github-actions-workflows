name: Upload public files to NAV CDN

on:
  workflow_call:
    inputs:
      team:
        description: "NAIS team name used for CDN upload (e.g. team-esyfo)."
        required: false
        type: string
        default: "team-esyfo"
      source:
        description: "Path to local folder to upload. Typically './public'."
        required: false
        type: string
        default: "./public"
      app:
        description: "Application name. Used to derive destination when destination is not provided."
        required: false
        type: string
        default: ""
      destination:
        description: "Destination path in the team CDN. Defaults to '/<app>'."
        required: false
        type: string
        default: ""
      nais-management-project-id:
        description: "NAIS management project id used for CDN upload. Typically passed from caller as vars.NAIS_MANAGEMENT_PROJECT_ID."
        required: false
        type: string
        default: ""
      skip-if-source-missing:
        description: "If true (default), skip upload when the source folder does not exist."
        required: false
        type: boolean
        default: true

jobs:
  upload-public:
    name: Upload public files to NAV CDN
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Check source folder
        id: check-source
        shell: bash
        run: |
          if [[ -d "${{ inputs.source }}" ]]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Validate destination config
        shell: bash
        run: |
          if [[ -z "${{ inputs.destination }}" && -z "${{ inputs.app }}" ]]; then
            echo "Either 'app' or 'destination' input must be set"
            exit 1
          fi

          if [[ -z "${{ inputs.nais-management-project-id }}" ]]; then
            echo "'nais-management-project-id' input must be set (typically vars.NAIS_MANAGEMENT_PROJECT_ID)."
            exit 1
          fi

          if [[ "${{ steps.check-source.outputs.exists }}" != "true" ]]; then
            if [[ "${{ inputs.skip-if-source-missing }}" == "true" ]]; then
              echo "Source folder '${{ inputs.source }}' not found; skipping CDN upload."
              exit 0
            fi

            echo "Source folder '${{ inputs.source }}' not found."
            exit 1
          fi

      - name: Upload public files to NAV CDN
        if: ${{ steps.check-source.outputs.exists == 'true' && github.actor != 'dependabot[bot]' }}
        uses: nais/deploy/actions/cdn-upload/v2@master
        with:
          team: ${{ inputs.team }}
          source: ${{ inputs.source }}
          destination: ${{ inputs.destination != '' && inputs.destination || format('/{0}', inputs.app) }}
          project_id: ${{ inputs.nais-management-project-id }}
          identity_provider: ${{ secrets.NAIS_WORKLOAD_IDENTITY_PROVIDER }}
